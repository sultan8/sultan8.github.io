function TraceManager(e,t){this.gd=e,this.origData=JSON.parse(JSON.stringify(e.data)),this.origOpacity=[];for(var r=0;r<this.origData.length;r++)this.origOpacity[r]=0===this.origData[r].opacity?0:this.origData[r].opacity||1;this.groupSelections={},this.highlight=t}function getMatchFunc(e){return e._isNestedKey?findNestedMatches:e._isSimpleKey?findSimpleMatches:findMatches}function findMatches(e,t){var r=[];return e.forEach(function(e,l){(null===e||t.indexOf(e)>=0)&&r.push(l)}),r}function findSimpleMatches(e,t){return e.every(function(e){return null===e||t.indexOf(e)>=0})?[0]:[]}function findNestedMatches(e,t){for(var r=[],l=0;l<e.length;l++){e[l].every(function(e){return null===e||t.indexOf(e)>=0})&&r.push(l)}return r}function isPlainObject(e){return"[object Object]"===Object.prototype.toString.call(e)&&Object.getPrototypeOf(e)===Object.prototype}function subsetArrayAttrs(e,t){var r={};return Object.keys(e).forEach(function(l){var i=e[l];"_"===l.charAt(0)?r[l]=i:"transforms"===l&&Array.isArray(i)?r[l]=i.map(function(e){return subsetArrayAttrs(e,t)}):"colorscale"===l&&Array.isArray(i)?r[l]=i:isPlainObject(i)?r[l]=subsetArrayAttrs(i,t):Array.isArray(i)?r[l]=subsetArray(i,t):r[l]=i}),r}function subsetArray(e,t){for(var r=[],l=0;l<t.length;l++)r.push(e[t[l]]);return r}function removeBrush(e){for(var t=e.querySelectorAll(".select-outline"),r=0;r<t.length;r++)t[r].remove()}function debounce(e,t,r){var l;return function(){var i=this,n=arguments,o=function(){l=null,r||e.apply(i,n)},a=r&&!l;clearTimeout(l),l=setTimeout(o,t),a&&e.apply(i,n)}}HTMLWidgets.widget({name:"plotly",type:"output",initialize:function(){return{}},resize:function(e,t,r,l){if(l.autosize){t=l.width||t,r=l.height||r;Plotly.relayout(e.id,{width:t,height:r})}},renderValue:function(e,t,r){function l(t){return t!==undefined&&t.hasOwnProperty("points")?t.points.map(function(t){var r={curveNumber:t.curveNumber,pointNumber:t.pointNumber,x:t.x,y:t.y};t.hasOwnProperty("z")&&(r.z=t.z),t.hasOwnProperty("customdata")&&(r.customdata=t.customdata);var l=document.getElementById(e.id).data[t.curveNumber];if(l._isSimpleKey){r.key=l.key;i=[]}else var i=["key"];for(var n=0;n<i.length;n++){var o=l[i[n]];Array.isArray(o)&&("number"==typeof t.pointNumber?r[i[n]]=o[t.pointNumber]:Array.isArray(t.pointNumber)?r[i[n]]=o[t.pointNumber[0]][t.pointNumber[1]]:Array.isArray(t.pointNumbers)&&(r[i[n]]=t.pointNumbers.map(function(e){return o[e]})))}return r}):null}function i(e){for(var t={},r=0;r<e.length;r++){var l=a.data[e[r].curveNumber];if(l.key&&l.set){t[l.set]=t[l.set]||{value:[],_isSimpleKey:l._isSimpleKey};var i="number"==typeof(i=e[r].pointNumber)?i:e[r].pointNumbers,n=l._isSimpleKey?l.key:Array.isArray(i)?i.map(function(e){return l.key[e]}):l.key[i],o=l._isNestedKey?[].concat.apply([],n):n;t[l.set].value=t[l.set].value.concat(o)}}return t}var n=t.layout||{};r.width=n.width,r.height=n.height,r.autosize=n.autosize||!0;crosstalk["var"]("plotlyCrosstalkOpts").set(t.highlight);if("undefined"!=typeof window){window.PLOTLYENV=window.PLOTLYENV||{},window.PLOTLYENV.BASE_URL=t.base_url;var o=function(e){e||window.event,e.shiftKey?(t.highlight.persistent=!0,t.highlight.persistentShift=!0):(t.highlight.persistent=!1,t.highlight.persistentShift=!1)};t.highlight.persistent||(window.onmousemove=o)}var a=document.getElementById(e.id);if(HTMLWidgets.addPostRenderHandler(function(){for(var e=document.querySelectorAll(".js-plotly-plot .plotly .modebar"),t=0;t<e.length;t++)e[t].style.zIndex=1}),(t.selectize||t.highlight.dynamic)&&!r.plotly){var s=document.createElement("div");if(s["class"]="plotly-crosstalk-control-panel",s.style="display: flex; flex-wrap: wrap",t.highlight.dynamic){var u=document.createElement("div"),h=document.createElement("input");h.id=e.id+"-colourpicker",h.placeholder="asdasd";var c=document.createElement("label");c["for"]=h.id,c.innerHTML="Brush color&nbsp;&nbsp;",u.appendChild(c),u.appendChild(h),s.appendChild(u)}if(t.selectize)for(var p=Object.keys(t.selectize),g=0;g<p.length;g++){var d=document.createElement("div");d.id=p[g],d.style="width: 80%; height: 10%",d["class"]="form-group crosstalk-input-plotly-highlight";var f=document.createElement("label");f["for"]=p[g],f.innerHTML=t.selectize[p[g]].group,f["class"]="control-label";var y=document.createElement("div");(H=document.createElement("select")).multiple=!0,y.appendChild(H),d.appendChild(f),d.appendChild(y),s.appendChild(d)}if(a.parentElement.insertBefore(s,a),t.highlight.dynamic){var v=$("#"+h.id),m=t.highlight.color||[],b={value:m[0],showColour:"both",palette:"limited",allowedCols:m.join(" "),width:"20%",height:"10%"};v.colourpicker({changeDelay:0}),v.colourpicker("settings",b),v.colourpicker("value",b.value);var _=t.highlight.ctGroups||[];for(g=0;g<_.length;g++)crosstalk.group(_[g])["var"]("plotlySelectionColour").set(v.colourpicker("value"));v.on("change",function(){for(var e=0;e<_.length;e++)crosstalk.group(_[e])["var"]("plotlySelectionColour").set(v.colourpicker("value"))})}}if(r.plotly)if(t.layout.transition)k=Plotly.react(a,t);else{Plotly.purge(a),a.data=undefined,a.layout=undefined;k=Plotly.newPlot(a,t)}else{var k=Plotly.newPlot(a,t);r.plotly=!0}k.then(function(){HTMLWidgets.shinyMode&&Shiny.addCustomMessageHandler("plotly-calls",function(e){var t=document.getElementById(e.id);if(!t)throw new Error("Couldn't find plotly graph with id: "+e.id);if("reconfig"!=e.method){if(!Plotly[e.method])throw new Error("Unknown method "+e.method);var r=[t].concat(e.args);Plotly[e.method].apply(null,r)}else Plotly.react(t,t.data,t.layout,e.args)});for(var e=a._fullLayout._subplots.mapbox||[],r=0;r<e.length;r++){var l=e[r],i=(t.layout[l]||{})._fitBounds||{};if(i)a._fullLayout[l]._subplot.map.fitBounds(i.bounds,i.options)}});var S=function(e){var t=e.data[e.curveNumber];if(!t.legendgroup)return t;var r=e.data.map(function(e){return e.legendgroup}),l=[];for(g=0;g<r.length;g++)r[g]==t.legendgroup&&l.push(e.data[g]);return l};if(HTMLWidgets.shinyMode&&Shiny.setInputValue){var w={plotly_deselect:["plotly_selected","plotly_selecting","plotly_brushed","plotly_brushing","plotly_click"],plotly_unhover:["plotly_hover"],plotly_doubleclick:["plotly_click"]};Object.keys(w).map(function(e){a.on(e,function(){w[e].map(function(e){Shiny.setInputValue(e+"-"+t.source,null,{priority:"event"})})})});var O={plotly_click:l,plotly_sunburstclick:l,plotly_hover:l,plotly_unhover:l,plotly_selected:function(e){if(e)return l(e)},plotly_selecting:function(e){if(e)return l(e)},plotly_brushed:function(e){if(e)return e.range?e.range:e.lassoPoints},plotly_brushing:function(e){if(e)return e.range?e.range:e.lassoPoints},plotly_legendclick:S,plotly_legenddoubleclick:S,plotly_clickannotation:function(e){return e.fullAnnotation}},A=function(r){var l=O[r]||function(t){return t||e.id},i="plotly_brushed"==r?"plotly_selected":"plotly_brushing"==r?"plotly_selecting":r;a.on(i,function(e){Shiny.setInputValue(r+"-"+t.source,JSON.stringify(l(e)),{priority:"event"})})};(t.shinyEvents||[]).map(A)}t.highlight.color=t.highlight.color||[],Array.isArray(t.highlight.color)||(t.highlight.color=[t.highlight.color]);for(var x=new TraceManager(a,t.highlight),N=[],P=0;P<t.data.length;P++){var M=t.data[P].set;M&&-1===N.indexOf(M)&&N.push(M)}for(g=0;g<N.length;g++){var E=N[g],D=new crosstalk.SelectionHandle(E),T=function(t){removeBrush(e),x.updateFilter(E,t.value)};new crosstalk.FilterHandle(E).on("change",T);var z=function(e){"plotly_selected"===t.highlight.on&&t.highlight.persistentShift&&(Array.prototype.diff=function(e){return this.filter(function(t){return e.indexOf(t)<0})},e.value=e.value.diff(e.oldValue));var r=crosstalk["var"]("plotlySelectionHistory").get()||[],l={receiverID:x.gd.id,plotlySelectionColour:crosstalk.group(E)["var"]("plotlySelectionColour").get()};if(l[E]=e.value,r.length>0)for(var i=JSON.stringify(l),n=0;n<r.length;n++){if(JSON.stringify(r[n])==i)return}t.highlight.persistent?r.push(l):r=[l],crosstalk["var"]("plotlySelectionHistory").set(r),x.updateSelection(E,e.value),t.selectize&&(t.highlight.persistent&&null!==e.value||B.clear(!0),B.addItems(e.value,!0),B.close())};D.on("change",z);var C=function(t){if(t){var r=i(t.points);for(var l in r)r.hasOwnProperty(l)&&D.set(r[l].value,{sender:e})}};if(t.highlight.debounce>0&&(C=debounce(C,t.highlight.debounce)),a.on(t.highlight.on,C),a.on(t.highlight.off,function(){removeBrush(e),crosstalk["var"]("plotlySelectionHistory").set(null),D.set(null,{sender:e})}),t.selectize){var I=Object.keys(t.selectize)[g],j=t.selectize[I],L=[{value:"",label:"(All)"}],H=(b=$.extend({options:L.concat(j.items),searchField:"label",valueField:"value",labelField:"label",maxItems:50},j),$("#"+I).find("select")[0]),B=$(H).selectize(b)[0].selectize;B.on("change",function(){var r=x.groupSelections[E]||[];if(!t.highlight.persistent){removeBrush(e);for(var l=0;l<r.length;l++)B.removeItem(r[l],!0)}var i=B.items.filter(function(e){return r.indexOf(e)<0});i.length>0?x.updateSelection(E,i):(x.updateSelection(E,null),x.updateSelection(E,B.items))})}}}}),TraceManager.prototype.close=function(){},TraceManager.prototype.updateFilter=function(e,t){if(null==t)this.gd.data=JSON.parse(JSON.stringify(this.origData));else{for(var r=[],l=0;l<this.origData.length;l++){var i=this.origData[l];if(i.key&&i.set===e){var n=getMatchFunc(i)(i.key,t);n.length>0&&(i._isSimpleKey||(i=subsetArrayAttrs(i,n)),r.push(i))}}this.gd.data=r}Plotly.redraw(this.gd)},TraceManager.prototype.updateSelection=function(e,t){if(null!==t&&!Array.isArray(t))throw new Error("Invalid keys argument; null or array expected");var r=this.gd.data.length-this.origData.length;if(null===t||!this.highlight.persistent&&r>0){for(var l=[],i=0;i<this.gd.data.length;i++)this.gd.data[i]._isCrosstalkTrace&&l.push(i);Plotly.deleteTraces(this.gd,l),this.groupSelections[e]=t}else{this.groupSelections[e]=this.groupSelections[e]||[];for(i=0;i<t.length;i++){var n=t[i];this.groupSelections[e].indexOf(n)<0&&this.groupSelections[e].push(n)}}if(null===t)Plotly.restyle(this.gd,{opacity:this.origOpacity});else if(t.length>=1){var o=[],a=crosstalk.group(e)["var"]("plotlySelectionColour").get()||this.highlight.color[0];for(i=0;i<this.origData.length;i++){var s=JSON.parse(JSON.stringify(this.gd.data[i]));if(s.key&&s.set===e)if((d=getMatchFunc(s)(s.key,t)).length>0){s._isSimpleKey||(s=subsetArrayAttrs(s,d));var u=this.gd._fullData[i];$.extend(!0,s,this.highlight.selected),u.marker&&(s.marker=s.marker||{},s.marker.color=a||s.marker.color||u.marker.color),u.line&&(s.line=s.line||{},s.line.color=a||s.line.color||u.line.color),u.textfont&&(s.textfont=s.textfont||{},s.textfont.color=a||s.textfont.color||u.textfont.color),u.fillcolor&&(s.fillcolor=a||s.fillcolor||u.fillcolor),s.name=s.name||t.join("<br />"),s.legendgroup=s.legendgroup||t.join("<br />"),s._originalIndex=i,s._newIndex=this.gd._fullData.length+o.length,s._isCrosstalkTrace=!0,o.push(s)}}if(o.length>0){Plotly.addTraces(this.gd,o).then(function(r){for(var l=r._transitionData._frameHash,i=r._transitionData._frames||[],n=0;n<i.length;n++){for(var a=[],u=0;u<o.length;u++){var h=o[u];i[n].traces.indexOf(h._originalIndex)>-1&&(a.push(h._newIndex),i[n].traces.push(h._newIndex))}if(0!==a.length){var c=0,p=i[n].data.length;for(u=0;u<p;u++){var g=i[n].data[u];if(g.key&&g.set===e){var d=getMatchFunc(g)(g.key,t);if(d.length>0){s._isSimpleKey||(g=subsetArrayAttrs(g,d));var f=r._fullData[a[c]];f.marker&&(g.marker=f.marker),f.line&&(g.line=f.line),f.textfont&&(g.textfont=f.textfont),c+=1,i[n].data.push(g)}}}l[i[n].name]=i[n]}}});var h=[],c=[],p=Object.keys(this.groupSelections),g=this.origData.length;for(i=0;i<g;i++){var d,f=this.origOpacity[i]||1;if(f===this.gd._fullData[i].opacity&&1!==this.highlight.opacityDim)(d=findMatches(p,[this.gd.data[i].set])).length&&(h.push(i),c.push(f*this.highlight.opacityDim))}h.length>0&&(Plotly.restyle(this.gd,{opacity:c},h),Plotly.restyle(this.gd,{selectedpoints:null}))}}};